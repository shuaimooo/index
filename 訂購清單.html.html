<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>優鮮雞肉批發管理系統 - Excel表格版</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        body { font-family: 'Inter', 'Noto Sans TC', sans-serif; }
        .glass-effect { backdrop-filter: blur(10px); background: rgba(255, 255, 255, 0.9); }
        .slide-in { animation: slideIn 0.4s ease-out; }
        @keyframes slideIn { from { opacity: 0; transform: translateX(-20px); } to { opacity: 1; transform: translateX(0); } }
        .bounce-in { animation: bounceIn 0.5s ease-out; }
        @keyframes bounceIn { 
            0% { opacity: 0; transform: scale(0.3); }
            50% { opacity: 1; transform: scale(1.05); }
            70% { transform: scale(0.9); }
            100% { opacity: 1; transform: scale(1); }
        }
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .card-hover { transition: all 0.3s ease; }
        .card-hover:hover { transform: translateY(-5px); box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); }
        
        /* Excel風格表格樣式 */
        .excel-table { border-collapse: collapse; }
        .excel-table th, .excel-table td { 
            border: 1px solid #d1d5db; 
            padding: 8px 12px; 
            text-align: left;
            position: relative;
        }
        .excel-table th { 
            background: #f3f4f6; 
            font-weight: 600;
            user-select: none;
        }
        .excel-table td { 
            background: white;
            min-width: 120px;
        }
        .excel-table td:hover { background: #f8fafc; }
        .excel-table td.selected { background: #dbeafe !important; }
        .excel-table tr.selected { background: #dbeafe; }
        
        .excel-input {
            border: none;
            background: transparent;
            width: 100%;
            padding: 4px;
            font-size: 14px;
        }
        .excel-input:focus {
            outline: 2px solid #3b82f6;
            background: white;
        }
        
        .column-header {
            cursor: pointer;
            user-select: none;
        }
        .column-header:hover {
            background: #e5e7eb;
        }
        
        .row-number {
            background: #f9fafb;
            color: #6b7280;
            font-weight: 500;
            text-align: center;
            width: 50px;
            cursor: pointer;
        }
        .row-number:hover {
            background: #e5e7eb;
        }
        
        .print-only { display: none; }
        @media print {
            body * { visibility: hidden; }
            .print-content, .print-content * { visibility: visible; }
            .print-content { position: absolute; left: 0; top: 0; width: 100%; }
            .print-only { display: block !important; }
            .no-print { display: none !important; }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-50 via-blue-50 to-indigo-100 min-h-screen">
    <!-- 頂部導航 -->
    <header class="glass-effect border-b border-white/20 sticky top-0 z-40">
        <div class="max-w-7xl mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <div class="w-12 h-12 gradient-bg rounded-xl flex items-center justify-center text-white text-2xl font-bold">
                        🐔
                    </div>
                    <div>
                        <h1 class="text-2xl font-bold text-gray-800">優鮮雞肉批發 - Excel表格版</h1>
                        <p class="text-sm text-gray-600">Professional Poultry Wholesale Management System</p>
                    </div>
                </div>
                <div class="flex items-center space-x-2">
                    <div class="text-right mr-4">
                        <div class="text-sm font-semibold text-gray-800">管理員</div>
                        <div class="text-xs text-gray-500">${new Date().toLocaleDateString('zh-TW')}</div>
                    </div>
                    <div class="w-10 h-10 bg-gradient-to-r from-blue-500 to-purple-600 rounded-full flex items-center justify-center text-white font-semibold">
                        A
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- 側邊導航 -->
    <div class="flex">
        <nav class="w-64 glass-effect border-r border-white/20 min-h-screen p-6 no-print">
            <div class="space-y-2">
                <button onclick="showModule('excel')" id="excelBtn" class="w-full flex items-center space-x-3 px-4 py-3 rounded-xl bg-gradient-to-r from-blue-500 to-blue-600 text-white font-medium transition-all">
                    <span class="text-xl">📊</span>
                    <span>Excel表格管理</span>
                </button>
                <button onclick="showModule('dashboard')" id="dashboardBtn" class="w-full flex items-center space-x-3 px-4 py-3 rounded-xl text-gray-700 hover:bg-white/50 font-medium transition-all">
                    <span class="text-xl">📈</span>
                    <span>營運儀表板</span>
                </button>
                <button onclick="showModule('procurement')" id="procurementBtn" class="w-full flex items-center space-x-3 px-4 py-3 rounded-xl text-gray-700 hover:bg-white/50 font-medium transition-all">
                    <span class="text-xl">📦</span>
                    <span>採購進貨管理</span>
                </button>
                <button onclick="showModule('finance')" id="financeBtn" class="w-full flex items-center space-x-3 px-4 py-3 rounded-xl text-gray-700 hover:bg-white/50 font-medium transition-all">
                    <span class="text-xl">💰</span>
                    <span>財務會計管理</span>
                </button>
                <button onclick="showModule('customer')" id="customerBtn" class="w-full flex items-center space-x-3 px-4 py-3 rounded-xl text-gray-700 hover:bg-white/50 font-medium transition-all">
                    <span class="text-xl">👥</span>
                    <span>客戶業務管理</span>
                </button>
                <button onclick="showModule('reports')" id="reportsBtn" class="w-full flex items-center space-x-3 px-4 py-3 rounded-xl text-gray-700 hover:bg-white/50 font-medium transition-all">
                    <span class="text-xl">📋</span>
                    <span>報表分析中心</span>
                </button>
            </div>
        </nav>

        <!-- 主要內容區域 -->
        <main class="flex-1 p-6">
            <!-- Excel表格管理 -->
            <div id="excelModule" class="slide-in">
                <div class="mb-8">
                    <h2 class="text-3xl font-bold text-gray-800 mb-2">Excel表格管理</h2>
                    <p class="text-gray-600">像Excel一樣編輯和管理您的業務數據</p>
                </div>

                <!-- 表格選擇器 -->
                <div class="mb-6">
                    <div class="flex flex-wrap gap-2">
                        <button onclick="showExcelTable('customers')" id="customersTabBtn" class="px-6 py-3 bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-lg hover:from-blue-600 hover:to-blue-700 transition-all font-semibold">👥 客戶資料表</button>
                        <button onclick="showExcelTable('orders')" id="ordersTabBtn" class="px-6 py-3 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-all font-semibold">📋 訂單記錄表</button>
                        <button onclick="showExcelTable('inventory')" id="inventoryTabBtn" class="px-6 py-3 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-all font-semibold">📦 庫存管理表</button>
                        <button onclick="showExcelTable('finance')" id="financeTabBtn" class="px-6 py-3 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-all font-semibold">💰 財務記錄表</button>
                        <button onclick="showExcelTable('suppliers')" id="suppliersTabBtn" class="px-6 py-3 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-all font-semibold">🏭 供應商表</button>
                    </div>
                </div>

                <!-- Excel表格容器 -->
                <div class="glass-effect rounded-2xl p-6 border border-white/20">
                    <div class="flex justify-between items-center mb-4">
                        <h3 id="excelTableTitle" class="text-xl font-semibold text-gray-800">👥 客戶資料表</h3>
                        <div class="flex flex-wrap gap-2">
                            <button onclick="addExcelRow()" class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition-colors text-sm">➕ 新增行</button>
                            <button onclick="deleteSelectedRows()" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors text-sm">🗑️ 刪除選中</button>
                            <button onclick="duplicateRow()" class="px-4 py-2 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600 transition-colors text-sm">📋 複製行</button>
                            <button onclick="sortTable()" class="px-4 py-2 bg-purple-500 text-white rounded-lg hover:bg-purple-600 transition-colors text-sm">🔄 排序</button>
                            <button onclick="exportToCSV()" class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors text-sm">📤 匯出CSV</button>
                            <button onclick="printExcelTable()" class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors text-sm">🖨️ 列印</button>
                        </div>
                    </div>
                    
                    <!-- 搜尋和篩選 -->
                    <div class="mb-4 flex gap-4">
                        <input type="text" id="searchInput" placeholder="🔍 搜尋..." class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" onkeyup="searchTable()">
                        <select id="filterColumn" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" onchange="filterTable()">
                            <option value="">篩選欄位...</option>
                        </select>
                        <button onclick="clearFilters()" class="px-4 py-2 bg-gray-400 text-white rounded-lg hover:bg-gray-500 transition-colors text-sm">清除篩選</button>
                    </div>
                    
                    <!-- Excel風格表格 -->
                    <div class="overflow-auto max-h-96 border border-gray-300 rounded-lg">
                        <table id="excelTable" class="excel-table w-full text-sm">
                            <thead id="excelTableHead" class="sticky top-0">
                                <!-- 動態生成表頭 -->
                            </thead>
                            <tbody id="excelTableBody">
                                <!-- 動態生成表格內容 -->
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- 表格統計 -->
                    <div class="mt-4 flex justify-between items-center text-sm text-gray-600">
                        <div id="tableStats">總計: 0 筆記錄</div>
                        <div class="flex space-x-4">
                            <span>選中: <span id="selectedCount">0</span> 行</span>
                            <span>數值總和: $<span id="sumValue">0</span></span>
                            <span>平均值: $<span id="avgValue">0</span></span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 營運儀表板 -->
            <div id="dashboardModule" class="hidden slide-in">
                <div class="mb-8">
                    <h2 class="text-3xl font-bold text-gray-800 mb-2">營運儀表板</h2>
                    <p class="text-gray-600">即時監控業務狀況與關鍵指標</p>
                </div>
                <div class="text-center py-12">
                    <div class="text-6xl mb-4">📊</div>
                    <h3 class="text-xl font-semibold text-gray-800 mb-2">儀表板功能</h3>
                    <p class="text-gray-600">基於Excel表格數據的即時統計分析</p>
                </div>
            </div>

            <!-- 其他模組佔位 -->
            <div id="procurementModule" class="hidden slide-in">
                <div class="text-center py-12">
                    <div class="text-6xl mb-4">📦</div>
                    <h3 class="text-xl font-semibold text-gray-800 mb-2">採購進貨管理</h3>
                    <p class="text-gray-600">使用Excel表格管理採購和庫存</p>
                </div>
            </div>

            <div id="financeModule" class="hidden slide-in">
                <div class="text-center py-12">
                    <div class="text-6xl mb-4">💰</div>
                    <h3 class="text-xl font-semibold text-gray-800 mb-2">財務會計管理</h3>
                    <p class="text-gray-600">使用Excel表格管理財務記錄</p>
                </div>
            </div>

            <div id="customerModule" class="hidden slide-in">
                <div class="text-center py-12">
                    <div class="text-6xl mb-4">👥</div>
                    <h3 class="text-xl font-semibold text-gray-800 mb-2">客戶業務管理</h3>
                    <p class="text-gray-600">使用Excel表格管理客戶資料</p>
                </div>
            </div>

            <div id="reportsModule" class="hidden slide-in">
                <div class="text-center py-12">
                    <div class="text-6xl mb-4">📋</div>
                    <h3 class="text-xl font-semibold text-gray-800 mb-2">報表分析中心</h3>
                    <p class="text-gray-600">基於Excel數據生成分析報表</p>
                </div>
            </div>
        </main>
    </div>

    <!-- 列印區域 -->
    <div id="printArea" class="print-content hidden">
        <div class="print-only p-8">
            <div class="text-center mb-8">
                <h1 class="text-3xl font-bold">優鮮雞肉批發</h1>
                <p class="text-lg text-gray-600">Professional Poultry Wholesale</p>
                <p class="text-sm text-gray-500">地址：台北市中山區民生東路456號 | 電話：02-2345-6789</p>
                <hr class="my-4">
            </div>
            <div id="printContent"></div>
            <div class="mt-8 text-center text-sm text-gray-500">
                <p>列印時間：${new Date().toLocaleString('zh-TW')}</p>
            </div>
        </div>
    </div>

    <!-- 隱藏的檔案輸入 -->
    <input type="file" id="csvFileInput" accept=".csv" style="display: none;" onchange="handleCSVImport(event)">

    <script>
        // 全域資料儲存
        let excelData = {
            customers: [],
            orders: [],
            inventory: [],
            finance: [],
            suppliers: []
        };

        // 當前選中的表格和行
        let currentTable = 'customers';
        let selectedRows = new Set();
        let selectedCells = new Set();

        // 表格結構定義
        const tableStructures = {
            customers: {
                title: '👥 客戶資料表',
                columns: [
                    { key: 'name', title: '客戶名稱', type: 'text' },
                    { key: 'contact', title: '聯絡人', type: 'text' },
                    { key: 'phone', title: '電話', type: 'tel' },
                    { key: 'email', title: '電子郵件', type: 'email' },
                    { key: 'address', title: '地址', type: 'text' },
                    { key: 'type', title: '客戶類型', type: 'select', options: ['餐廳', '雞肉攤', '超市', '便當店', '其他'] },
                    { key: 'grade', title: '客戶等級', type: 'select', options: ['鑽石級', '白金級', '黃金級', '銀級', '銅級'] },
                    { key: 'paymentTerms', title: '付款條件', type: 'select', options: ['現金', '月結15天', '月結30天', '月結45天'] },
                    { key: 'monthlyAmount', title: '月購金額', type: 'number' },
                    { key: 'status', title: '狀態', type: 'select', options: ['活躍', '暫停', '待聯繫'] },
                    { key: 'notes', title: '備註', type: 'text' }
                ]
            },
            orders: {
                title: '📋 訂單記錄表',
                columns: [
                    { key: 'orderNumber', title: '訂單編號', type: 'text' },
                    { key: 'date', title: '訂單日期', type: 'date' },
                    { key: 'customer', title: '客戶名稱', type: 'text' },
                    { key: 'product', title: '商品名稱', type: 'text' },
                    { key: 'quantity', title: '數量(kg)', type: 'number' },
                    { key: 'unitPrice', title: '單價', type: 'number' },
                    { key: 'totalAmount', title: '總金額', type: 'number' },
                    { key: 'deliveryDate', title: '交貨日期', type: 'date' },
                    { key: 'status', title: '訂單狀態', type: 'select', options: ['待處理', '處理中', '已出貨', '已完成', '已取消'] },
                    { key: 'paymentStatus', title: '付款狀態', type: 'select', options: ['未付款', '部分付款', '已付款'] },
                    { key: 'notes', title: '備註', type: 'text' }
                ]
            },
            inventory: {
                title: '📦 庫存管理表',
                columns: [
                    { key: 'productCode', title: '商品編號', type: 'text' },
                    { key: 'productName', title: '商品名稱', type: 'text' },
                    { key: 'category', title: '商品類別', type: 'select', options: ['雞胸肉', '雞腿肉', '全雞', '雞翅', '雞腳', '內臟'] },
                    { key: 'supplier', title: '供應商', type: 'text' },
                    { key: 'currentStock', title: '現有庫存(kg)', type: 'number' },
                    { key: 'safetyStock', title: '安全庫存(kg)', type: 'number' },
                    { key: 'unitCost', title: '進貨成本', type: 'number' },
                    { key: 'sellingPrice', title: '銷售價格', type: 'number' },
                    { key: 'expiryDate', title: '保存期限', type: 'date' },
                    { key: 'location', title: '存放位置', type: 'text' },
                    { key: 'status', title: '庫存狀態', type: 'select', options: ['充足', '偏低', '不足', '過期'] }
                ]
            },
            finance: {
                title: '💰 財務記錄表',
                columns: [
                    { key: 'date', title: '日期', type: 'date' },
                    { key: 'type', title: '類型', type: 'select', options: ['收入', '支出'] },
                    { key: 'category', title: '科目', type: 'text' },
                    { key: 'description', title: '說明', type: 'text' },
                    { key: 'amount', title: '金額', type: 'number' },
                    { key: 'paymentMethod', title: '付款方式', type: 'select', options: ['現金', '銀行轉帳', '支票', '信用卡'] },
                    { key: 'invoiceNumber', title: '發票號碼', type: 'text' },
                    { key: 'customer', title: '客戶/供應商', type: 'text' },
                    { key: 'status', title: '狀態', type: 'select', options: ['已確認', '待確認', '已取消'] },
                    { key: 'notes', title: '備註', type: 'text' }
                ]
            },
            suppliers: {
                title: '🏭 供應商表',
                columns: [
                    { key: 'name', title: '供應商名稱', type: 'text' },
                    { key: 'contact', title: '聯絡人', type: 'text' },
                    { key: 'phone', title: '電話', type: 'tel' },
                    { key: 'email', title: '電子郵件', type: 'email' },
                    { key: 'address', title: '地址', type: 'text' },
                    { key: 'products', title: '主要商品', type: 'text' },
                    { key: 'paymentTerms', title: '付款條件', type: 'select', options: ['現金', '月結15天', '月結30天', '月結45天'] },
                    { key: 'rating', title: '評等', type: 'select', options: ['優良', '良好', '普通', '待改善'] },
                    { key: 'monthlyAmount', title: '月採購額', type: 'number' },
                    { key: 'status', title: '狀態', type: 'select', options: ['合作中', '暫停', '評估中'] },
                    { key: 'notes', title: '備註', type: 'text' }
                ]
            }
        };

        // 模組切換功能
        function showModule(moduleName) {
            const modules = ['excel', 'dashboard', 'procurement', 'finance', 'customer', 'reports'];
            modules.forEach(module => {
                const moduleElement = document.getElementById(module + 'Module');
                const btnElement = document.getElementById(module + 'Btn');
                if (moduleElement) moduleElement.classList.add('hidden');
                if (btnElement) btnElement.className = 'w-full flex items-center space-x-3 px-4 py-3 rounded-xl text-gray-700 hover:bg-white/50 font-medium transition-all';
            });
            
            const targetModule = document.getElementById(moduleName + 'Module');
            const targetBtn = document.getElementById(moduleName + 'Btn');
            if (targetModule) targetModule.classList.remove('hidden');
            if (targetBtn) targetBtn.className = 'w-full flex items-center space-x-3 px-4 py-3 rounded-xl bg-gradient-to-r from-blue-500 to-blue-600 text-white font-medium transition-all';
        }

        // Excel表格功能
        function showExcelTable(tableName) {
            currentTable = tableName;
            selectedRows.clear();
            selectedCells.clear();
            
            // 更新標籤按鈕樣式
            const tabButtons = ['customersTabBtn', 'ordersTabBtn', 'inventoryTabBtn', 'financeTabBtn', 'suppliersTabBtn'];
            tabButtons.forEach(btnId => {
                const btn = document.getElementById(btnId);
                if (btn) {
                    btn.className = 'px-6 py-3 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300 transition-all font-semibold';
                }
            });
            
            const activeBtn = document.getElementById(tableName + 'TabBtn');
            if (activeBtn) {
                activeBtn.className = 'px-6 py-3 bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-lg hover:from-blue-600 hover:to-blue-700 transition-all font-semibold';
            }
            
            // 更新表格標題
            document.getElementById('excelTableTitle').textContent = tableStructures[tableName].title;
            
            // 更新篩選選項
            updateFilterOptions();
            
            // 渲染表格
            renderExcelTable();
            updateTableStats();
        }

        function renderExcelTable() {
            const structure = tableStructures[currentTable];
            const data = excelData[currentTable];
            
            // 渲染表頭
            const thead = document.getElementById('excelTableHead');
            thead.innerHTML = `
                <tr>
                    <th class="row-number">#</th>
                    ${structure.columns.map((col, index) => `
                        <th class="column-header" onclick="sortByColumn(${index})" title="點擊排序">
                            ${col.title}
                            <span class="text-xs text-gray-400 ml-1">↕️</span>
                        </th>
                    `).join('')}
                </tr>
            `;
            
            // 渲染表格內容
            const tbody = document.getElementById('excelTableBody');
            if (data.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="${structure.columns.length + 1}" class="text-center py-8 text-gray-500">
                            <div class="text-2xl mb-2">📝</div>
                            <div>尚無資料，點擊「新增行」開始建立</div>
                        </td>
                    </tr>
                `;
            } else {
                tbody.innerHTML = data.map((row, rowIndex) => `
                    <tr class="${selectedRows.has(rowIndex) ? 'selected' : ''}" onclick="selectRow(${rowIndex}, event)">
                        <td class="row-number">${rowIndex + 1}</td>
                        ${structure.columns.map((col, colIndex) => `
                            <td class="${selectedCells.has(`${rowIndex}-${colIndex}`) ? 'selected' : ''}" 
                                onclick="selectCell(${rowIndex}, ${colIndex}, event)">
                                ${renderCell(row[col.key] || '', col, rowIndex, colIndex)}
                            </td>
                        `).join('')}
                    </tr>
                `).join('');
            }
        }

        function renderCell(value, column, rowIndex, colIndex) {
            if (column.type === 'select') {
                return `
                    <select class="excel-input" onchange="updateCellValue(${rowIndex}, '${column.key}', this.value)">
                        <option value="">${value || '請選擇...'}</option>
                        ${column.options.map(option => `
                            <option value="${option}" ${value === option ? 'selected' : ''}>${option}</option>
                        `).join('')}
                    </select>
                `;
            } else {
                return `
                    <input type="${column.type}" 
                           class="excel-input" 
                           value="${value || ''}" 
                           onchange="updateCellValue(${rowIndex}, '${column.key}', this.value)"
                           ${column.type === 'number' ? 'step="0.01"' : ''}
                           placeholder="輸入${column.title}...">
                `;
            }
        }

        function updateCellValue(rowIndex, key, value) {
            if (!excelData[currentTable][rowIndex]) {
                excelData[currentTable][rowIndex] = {};
            }
            excelData[currentTable][rowIndex][key] = value;
            
            // 如果是訂單表格，自動計算總金額
            if (currentTable === 'orders' && (key === 'quantity' || key === 'unitPrice')) {
                const row = excelData[currentTable][rowIndex];
                if (row.quantity && row.unitPrice) {
                    row.totalAmount = (parseFloat(row.quantity) * parseFloat(row.unitPrice)).toFixed(2);
                    renderExcelTable(); // 重新渲染以顯示計算結果
                }
            }
            
            updateTableStats();
            showNotification('資料已更新', 'success');
        }

        function selectRow(rowIndex, event) {
            event.stopPropagation();
            
            if (event.ctrlKey || event.metaKey) {
                // 多選模式
                if (selectedRows.has(rowIndex)) {
                    selectedRows.delete(rowIndex);
                } else {
                    selectedRows.add(rowIndex);
                }
            } else {
                // 單選模式
                selectedRows.clear();
                selectedRows.add(rowIndex);
            }
            
            renderExcelTable();
            updateTableStats();
        }

        function selectCell(rowIndex, colIndex, event) {
            event.stopPropagation();
            
            const cellKey = `${rowIndex}-${colIndex}`;
            if (event.ctrlKey || event.metaKey) {
                if (selectedCells.has(cellKey)) {
                    selectedCells.delete(cellKey);
                } else {
                    selectedCells.add(cellKey);
                }
            } else {
                selectedCells.clear();
                selectedCells.add(cellKey);
            }
            
            renderExcelTable();
        }

        function addExcelRow() {
            const structure = tableStructures[currentTable];
            const newRow = {};
            
            // 初始化新行的預設值
            structure.columns.forEach(col => {
                if (col.key === 'date' || col.key === 'orderDate') {
                    newRow[col.key] = new Date().toISOString().split('T')[0];
                } else if (col.key === 'orderNumber') {
                    newRow[col.key] = 'ORD-' + new Date().getFullYear() + '-' + String(Date.now()).slice(-6);
                } else if (col.key === 'productCode') {
                    newRow[col.key] = 'PRD-' + String(Date.now()).slice(-6);
                } else {
                    newRow[col.key] = '';
                }
            });
            
            excelData[currentTable].push(newRow);
            renderExcelTable();
            updateTableStats();
            showNotification('已新增一行', 'success');
        }

        function deleteSelectedRows() {
            if (selectedRows.size === 0) {
                showNotification('請先選擇要刪除的行', 'error');
                return;
            }
            
            if (confirm(`確定要刪除選中的 ${selectedRows.size} 行嗎？`)) {
                const sortedRows = Array.from(selectedRows).sort((a, b) => b - a);
                sortedRows.forEach(rowIndex => {
                    excelData[currentTable].splice(rowIndex, 1);
                });
                
                selectedRows.clear();
                selectedCells.clear();
                renderExcelTable();
                updateTableStats();
                showNotification(`已刪除 ${sortedRows.length} 行`, 'success');
            }
        }

        function duplicateRow() {
            if (selectedRows.size !== 1) {
                showNotification('請選擇一行進行複製', 'error');
                return;
            }
            
            const rowIndex = Array.from(selectedRows)[0];
            const originalRow = excelData[currentTable][rowIndex];
            const duplicatedRow = { ...originalRow };
            
            // 更新特殊欄位
            if (duplicatedRow.orderNumber) {
                duplicatedRow.orderNumber = 'ORD-' + new Date().getFullYear() + '-' + String(Date.now()).slice(-6);
            }
            if (duplicatedRow.productCode) {
                duplicatedRow.productCode = 'PRD-' + String(Date.now()).slice(-6);
            }
            
            excelData[currentTable].splice(rowIndex + 1, 0, duplicatedRow);
            renderExcelTable();
            updateTableStats();
            showNotification('已複製行', 'success');
        }

        function sortByColumn(columnIndex) {
            const structure = tableStructures[currentTable];
            const column = structure.columns[columnIndex];
            const data = excelData[currentTable];
            
            data.sort((a, b) => {
                const aVal = a[column.key] || '';
                const bVal = b[column.key] || '';
                
                if (column.type === 'number') {
                    return parseFloat(aVal) - parseFloat(bVal);
                } else if (column.type === 'date') {
                    return new Date(aVal) - new Date(bVal);
                } else {
                    return aVal.toString().localeCompare(bVal.toString());
                }
            });
            
            renderExcelTable();
            showNotification(`已按 ${column.title} 排序`, 'success');
        }

        function searchTable() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const rows = document.querySelectorAll('#excelTableBody tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                if (text.includes(searchTerm)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }

        function updateFilterOptions() {
            const structure = tableStructures[currentTable];
            const filterSelect = document.getElementById('filterColumn');
            
            filterSelect.innerHTML = `
                <option value="">篩選欄位...</option>
                ${structure.columns.map(col => `
                    <option value="${col.key}">${col.title}</option>
                `).join('')}
            `;
        }

        function filterTable() {
            const filterColumn = document.getElementById('filterColumn').value;
            if (!filterColumn) return;
            
            const uniqueValues = [...new Set(excelData[currentTable].map(row => row[filterColumn]).filter(val => val))];
            
            if (uniqueValues.length === 0) {
                showNotification('該欄位沒有資料可篩選', 'error');
                return;
            }
            
            const selectedValue = prompt(`選擇篩選值：\n${uniqueValues.join('\n')}`);
            if (selectedValue) {
                const rows = document.querySelectorAll('#excelTableBody tr');
                rows.forEach((row, index) => {
                    if (index === 0 && row.cells.length === 1) return; // 跳過空狀態行
                    
                    const rowData = excelData[currentTable][index];
                    if (rowData && rowData[filterColumn] === selectedValue) {
                        row.style.display = '';
                    } else {
                        row.style.display = 'none';
                    }
                });
            }
        }

        function clearFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('filterColumn').value = '';
            const rows = document.querySelectorAll('#excelTableBody tr');
            rows.forEach(row => {
                row.style.display = '';
            });
            showNotification('已清除所有篩選', 'success');
        }

        function updateTableStats() {
            const data = excelData[currentTable];
            const structure = tableStructures[currentTable];
            
            // 更新基本統計
            document.getElementById('tableStats').textContent = `總計: ${data.length} 筆記錄`;
            document.getElementById('selectedCount').textContent = selectedRows.size;
            
            // 計算數值欄位的總和和平均值
            const numberColumns = structure.columns.filter(col => col.type === 'number');
            let totalSum = 0;
            let count = 0;
            
            data.forEach(row => {
                numberColumns.forEach(col => {
                    const value = parseFloat(row[col.key]);
                    if (!isNaN(value)) {
                        totalSum += value;
                        count++;
                    }
                });
            });
            
            document.getElementById('sumValue').textContent = totalSum.toLocaleString();
            document.getElementById('avgValue').textContent = count > 0 ? (totalSum / count).toFixed(2) : '0';
        }

        function exportToCSV() {
            const structure = tableStructures[currentTable];
            const data = excelData[currentTable];
            
            if (data.length === 0) {
                showNotification('沒有資料可匯出', 'error');
                return;
            }
            
            // 建立CSV內容
            const headers = structure.columns.map(col => col.title).join(',');
            const rows = data.map(row => 
                structure.columns.map(col => {
                    const value = row[col.key] || '';
                    return `"${value.toString().replace(/"/g, '""')}"`;
                }).join(',')
            );
            
            const csvContent = [headers, ...rows].join('\n');
            
            // 下載檔案
            const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `${currentTable}_${new Date().toISOString().split('T')[0]}.csv`;
            link.click();
            
            showNotification('CSV檔案已匯出', 'success');
        }

        function importFromCSV() {
            document.getElementById('csvFileInput').click();
        }

        function handleCSVImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const csv = e.target.result;
                    const lines = csv.split('\n').filter(line => line.trim());
                    
                    if (lines.length < 2) {
                        showNotification('CSV檔案格式不正確', 'error');
                        return;
                    }
                    
                    const structure = tableStructures[currentTable];
                    const headers = lines[0].split(',').map(h => h.replace(/"/g, '').trim());
                    
                    const importedData = [];
                    for (let i = 1; i < lines.length; i++) {
                        const values = lines[i].split(',').map(v => v.replace(/"/g, '').trim());
                        const row = {};
                        
                        structure.columns.forEach((col, index) => {
                            if (index < values.length) {
                                row[col.key] = values[index];
                            }
                        });
                        
                        importedData.push(row);
                    }
                    
                    if (confirm(`將匯入 ${importedData.length} 筆資料，是否繼續？`)) {
                        excelData[currentTable] = [...excelData[currentTable], ...importedData];
                        renderExcelTable();
                        updateTableStats();
                        showNotification(`已匯入 ${importedData.length} 筆資料`, 'success');
                    }
                } catch (error) {
                    showNotification('CSV檔案解析失敗', 'error');
                }
            };
            
            reader.readAsText(file, 'UTF-8');
            event.target.value = ''; // 清除檔案選擇
        }

        function printExcelTable() {
            const structure = tableStructures[currentTable];
            const data = excelData[currentTable];
            
            let tableHTML = `
                <table class="w-full border-collapse border border-gray-300">
                    <thead>
                        <tr class="bg-gray-100">
                            ${structure.columns.map(col => `<th class="border border-gray-300 p-2 text-left">${col.title}</th>`).join('')}
                        </tr>
                    </thead>
                    <tbody>
                        ${data.map(row => `
                            <tr>
                                ${structure.columns.map(col => `<td class="border border-gray-300 p-2">${row[col.key] || ''}</td>`).join('')}
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            
            document.getElementById('printContent').innerHTML = `
                <h2 class="text-2xl font-bold mb-4">${structure.title}</h2>
                <p class="mb-4">列印日期：${new Date().toLocaleDateString('zh-TW')} | 總計：${data.length} 筆記錄</p>
                ${tableHTML}
            `;
            
            document.getElementById('printArea').classList.remove('hidden');
            window.print();
            document.getElementById('printArea').classList.add('hidden');
        }

        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 p-4 rounded-xl shadow-lg z-50 ${type === 'success' ? 'bg-green-500' : 'bg-red-500'} text-white max-w-sm bounce-in`;
            notification.innerHTML = `
                <div class="flex items-center">
                    <span class="mr-2">${type === 'success' ? '✅' : '❌'}</span>
                    <span>${message}</span>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // 鍵盤快捷鍵
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey || e.metaKey) {
                switch(e.key) {
                    case 'n':
                        e.preventDefault();
                        addExcelRow();
                        break;
                    case 'd':
                        e.preventDefault();
                        duplicateRow();
                        break;
                    case 'Delete':
                        e.preventDefault();
                        deleteSelectedRows();
                        break;
                    case 's':
                        e.preventDefault();
                        exportToCSV();
                        break;
                }
            }
        });

        // 頁面載入初始化
        document.addEventListener('DOMContentLoaded', function() {
            showExcelTable('customers');
            
            // 添加一些範例資料
            excelData.customers = [
                {
                    name: '範例客戶',
                    contact: '張先生',
                    phone: '02-1234-5678',
                    email: 'example@email.com',
                    address: '台北市中山區',
                    type: '餐廳',
                    grade: '黃金級',
                    paymentTerms: '月結30天',
                    monthlyAmount: '50000',
                    status: '活躍',
                    notes: '優質客戶'
                }
            ];
            
            renderExcelTable();
            updateTableStats();
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'975c3a1701834a1b',t:'MTc1NjMwNDYwOC4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
