<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ç”Ÿé®®é›å‡ºè²¨ï¼å°å¸³ï¼åˆ†æ ä¸€é é€š</title>
<style>
  :root{
    --bg:#0f172a; --card:#111827; --muted:#94a3b8; --text:#e5e7eb; --accent:#22c55e; --warn:#f59e0b; --danger:#ef4444; --line:#1f2937;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans TC",sans-serif;background:var(--bg);color:var(--text)}
  header{padding:16px 20px;border-bottom:1px solid var(--line);display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  h1{font-size:20px;margin:0}
  .tabs{display:flex;gap:8px;flex-wrap:wrap}
  .tab-btn{border:1px solid var(--line);background:#0b1220;color:var(--text);padding:8px 12px;border-radius:999px;cursor:pointer}
  .tab-btn.active{border-color:var(--accent);box-shadow:0 0 0 2px #22c55e33 inset}
  main{padding:16px;display:grid;gap:16px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:16px}
  .row{display:grid;gap:12px}
  .grid-2{grid-template-columns:repeat(2,minmax(0,1fr))}
  .grid-3{grid-template-columns:repeat(3,minmax(0,1fr))}
  .grid-4{grid-template-columns:repeat(4,minmax(0,1fr))}
  label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
  input,select,textarea{width:100%;background:#0b1220;border:1px solid var(--line);color:var(--text);padding:10px 12px;border-radius:10px;outline:none}
  input[type="date"]{padding:8px 12px}
  input:focus,select:focus,textarea:focus{border-color:#334155;box-shadow:0 0 0 2px #33415580}
  .btn{background:#0b1220;border:1px solid var(--line);color:var(--text);padding:10px 14px;border-radius:12px;cursor:pointer}
  .btn.primary{background:linear-gradient(180deg,#16a34a,#15803d);border-color:#14532d}
  .btn.warn{background:#1f2937;border-color:#374151;color:#fde68a}
  .btn.danger{background:#1f2937;border-color:#374151;color:#fecaca}
  .btn:disabled{opacity:.5;cursor:not-allowed}
  table{width:100%;border-collapse:collapse;border-spacing:0}
  th,td{border-bottom:1px solid var(--line);padding:10px;text-align:left;vertical-align:top}
  th{font-weight:600;color:#cbd5e1;background:#0b1220;position:sticky;top:0;z-index:1}
  tr:hover td{background:#0b1220}
  .pill{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid var(--line);font-size:12px;color:#cbd5e1}
  .pill.green{border-color:#065f46;color:#bbf7d0;background:#064e3b}
  .pill.red{border-color:#7f1d1d;color:#fecaca;background:#3f1212}
  .right{display:flex;gap:8px;align-items:center;justify-content:flex-end;flex-wrap:wrap}
  .totals{display:flex;gap:16px;flex-wrap:wrap}
  .kpi{background:#0b1220;border:1px solid var(--line);padding:12px 14px;border-radius:12px}
  .kpi b{font-size:18px}
  .hint{color:var(--muted);font-size:12px}
  .danger-text{color:#fecaca}
  .ok-text{color:#bbf7d0}
  .flex{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
  .grow{flex:1}
  .nowrap{white-space:nowrap}
  .badge{font-size:11px;border:1px solid var(--line);padding:2px 6px;border-radius:999px;color:#cbd5e1}
  .chart{width:100%;height:260px;background:#0b1220;border:1px solid var(--line);border-radius:12px;overflow:hidden}
  .footer{color:var(--muted);font-size:12px;padding:8px 16px 20px}
  .bar{height:100%;background:#22c55e}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .input-sm{padding:6px 10px;border-radius:8px}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,monospace}
</style>
</head>
<body>
<header>
  <h1>ğŸ” ç”Ÿé®®é›ï½œå‡ºè²¨ï¼å°å¸³ï¼åˆ†æ</h1>
  <div class="tabs">
    <button class="tab-btn active" data-tab="ship">å‡ºè²¨ç´€éŒ„</button>
    <button class="tab-btn" data-tab="ar">æ‡‰æ”¶å¸³æ¬¾</button>
    <button class="tab-btn" data-tab="ap">æ‡‰ä»˜ï¼ˆä¸Šæ¸¸ï¼‰</button>
    <button class="tab-btn" data-tab="analytics">çµ±è¨ˆåˆ†æ</button>
    <button class="tab-btn" data-tab="settings">è¨­å®š / åŒ¯å…¥åŒ¯å‡º</button>
  </div>
</header>

<main>
  <!-- å‡ºè²¨ç´€éŒ„ -->
  <section class="card" id="tab-ship">
    <h2 style="margin:0 0 10px">â‘  å‡ºè²¨ï¼äº¤æ˜“åŸºæœ¬ç´€éŒ„</h2>
    <div class="hint">æ¯æ—¥è¼¸å…¥ä¸€ç­†å–®é …æ˜ç´°ï¼šé‡‘é¡æœƒè‡ªå‹•ï¼ï¼ˆé‡é‡æˆ–éš»/ä»¶æ•¸ï¼‰Ã— å–®åƒ¹ã€‚è³‡æ–™æœƒå­˜æœ¬æ©Ÿ LocalStorageã€‚</div>
    <div class="row grid-4" style="margin-top:12px">
      <div>
        <label>æ—¥æœŸ</label>
        <input type="date" id="s-date">
      </div>
      <div>
        <label>å®¢æˆ¶åç¨±</label>
        <input id="s-client" placeholder="ä¾‹ï¼šæ”¤å•†A / ç…®é›å» B / é›¶å”®å•†C">
      </div>
      <div>
        <label>é¡åˆ¥</label>
        <select id="s-type">
          <option value="å…¨é›">å…¨é›</option>
          <option value="åˆ†åˆ‡">åˆ†åˆ‡</option>
          <option value="å†·å‡">å†·å‡</option>
        </select>
      </div>
      <div>
        <label>éƒ¨ä½</label>
        <input id="s-part" placeholder="ä¾‹ï¼šå»æ¯›é›ï¼è…¿æ’ï¼é›èƒ¸â€¦">
      </div>

      <div>
        <label>è¦æ ¼</label>
        <input id="s-spec" placeholder="ä¾‹ï¼šå¤§éš»ã€å°åŒ…â€¦">
      </div>
      <div>
        <label>å–®ä½</label>
        <select id="s-unit">
          <option value="å…¬æ–¤">å…¬æ–¤</option>
          <option value="å…‹">å…‹</option>
          <option value="æ–¤">æ–¤</option>
        </select>
      </div>
      <div>
        <label>é‡é‡</label>
        <input id="s-weight" type="number" step="0.001" placeholder="kg/g/æ–¤">
      </div>
      <div>
        <label>å–®åƒ¹</label>
        <input id="s-price" type="number" step="0.01" placeholder="æ¯å–®ä½å–®åƒ¹">
      </div>

      <div>
        <label>éš»æ•¸</label>
        <input id="s-birds" type="number" step="1" placeholder="è‹¥ä»¥é‡é‡è¨ˆåƒ¹å¯ç•™ç©º">
      </div>
      <div>
        <label>ä»¶æ•¸</label>
        <input id="s-packs" type="number" step="1" placeholder="è‹¥ä»¥é‡é‡è¨ˆåƒ¹å¯ç•™ç©º">
      </div>
      <div>
        <label>é‡‘é¡ï¼ˆè‡ªå‹•ï¼‰</label>
        <input id="s-amount" class="mono" placeholder="è‡ªå‹•è¨ˆç®—" disabled>
      </div>
      <div>
        <label>å‚™è¨» / æ“ä½œ</label>
        <input id="s-note" placeholder="ä¾‹ï¼šå·²å‡ºè²¨ã€ç­‰æ”¶æ¬¾ã€é€€å›1ä»¶â€¦">
      </div>
    </div>

    <div class="right" style="margin-top:10px">
      <button class="btn" id="btn-clear-form" title="æ¸…ç©ºè¡¨å–®">æ¸…ç©º</button>
      <button class="btn primary" id="btn-add">æ–°å¢æ˜ç´°</button>
    </div>

    <div class="totals" style="margin-top:16px">
      <div class="kpi">ä»Šæ—¥é‡‘é¡åˆè¨ˆï¼š<b class="mono" id="kpi-today">0</b></div>
      <div class="kpi">æœ¬æœˆé‡‘é¡åˆè¨ˆï¼š<b class="mono" id="kpi-month">0</b></div>
      <div class="kpi">ç­†æ•¸ï¼š<b class="mono" id="kpi-count">0</b></div>
    </div>

    <div class="toolbar" style="margin-top:12px">
      <input class="input-sm grow" id="filter" placeholder="å¿«é€Ÿç¯©é¸ï¼ˆå®¢æˆ¶ï¼é¡åˆ¥ï¼éƒ¨ä½ï¼å‚™è¨»ï¼‰">
      <div class="flex">
        <label>æœˆä»½</label>
        <input class="input-sm" type="month" id="filter-month">
      </div>
      <div class="flex">
        <label>å®¢æˆ¶</label>
        <input class="input-sm" id="filter-client" placeholder="å…¨éƒ¨">
      </div>
      <button class="btn" id="btn-reset-filter">æ¸…é™¤ç¯©é¸</button>
    </div>

    <div class="card" style="margin-top:12px;padding:0;overflow:auto;max-height:60vh">
      <table id="tbl-ship">
        <thead>
          <tr>
            <th>æ—¥æœŸ</th><th>å®¢æˆ¶</th><th>é¡åˆ¥</th><th>éƒ¨ä½</th><th>è¦æ ¼</th>
            <th>é‡é‡</th><th>å–®ä½</th><th>éš»æ•¸</th><th>ä»¶æ•¸</th><th>å–®åƒ¹</th><th>é‡‘é¡</th><th>å‚™è¨»</th><th>åˆªé™¤</th>
          </tr>
        </thead>
        <tbody></tbody>
        <tfoot>
          <tr>
            <th colspan="10" style="text-align:right">å°è¨ˆ</th>
            <th class="mono" id="ship-subtotal">0</th>
            <th colspan="2"></th>
          </tr>
        </tfoot>
      </table>
    </div>
  </section>

  <!-- æ‡‰æ”¶å¸³æ¬¾ -->
  <section class="card" id="tab-ar" style="display:none">
    <h2 style="margin:0 0 10px">â‘¡ æ‡‰æ”¶å¸³æ¬¾ï¼ˆä¸‹æ¸¸å®¢æˆ¶å°å¸³ï¼‰</h2>
    <div class="hint">
      è¦å‰‡å»ºè­°ï¼šä¸‹æ¸¸å®¢æˆ¶å¤šç‚ºã€Œ1 è™Ÿçµç®—ï¼Œ15 è™Ÿä»˜æ¬¾ã€ã€‚æœ¬è¡¨æœƒä¾ã€Œå‡ºè²¨ç´€éŒ„ã€è‡ªå‹•å½™ç¸½ç•¶æœˆå‡ºè²¨é‡‘é¡ï¼›ä½ å¯å¡«ã€Œå·²æ”¶é‡‘é¡ã€æ”¶æ¬¾æ—¥æœŸã€åŒ¯æ¬¾å¸³è™Ÿã€ã€‚
    </div>

    <div class="toolbar" style="margin-top:12px">
      <div class="flex"><label>æœˆä»½</label><input class="input-sm" type="month" id="ar-month"></div>
      <button class="btn" id="btn-ar-refresh">é‡æ–°æ•´ç†</button>
    </div>

    <div class="card" style="margin-top:12px;padding:0;overflow:auto;max-height:60vh">
      <table id="tbl-ar">
        <thead>
        <tr>
          <th>å®¢æˆ¶</th><th>æœ¬æœˆå‡ºè²¨é‡‘é¡</th><th>çµç®—æ—¥</th><th>ä»˜æ¬¾æœŸé™</th>
          <th>å·²æ”¶é‡‘é¡</th><th>æœªæ”¶é‡‘é¡</th><th>æ”¶æ¬¾æ—¥æœŸ</th><th>åŒ¯æ¬¾å¸³è™Ÿ</th><th>ç‹€æ…‹</th>
        </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <!-- æ‡‰ä»˜ï¼ˆä¸Šæ¸¸ï¼‰ -->
  <section class="card" id="tab-ap" style="display:none">
    <h2 style="margin:0 0 10px">â‘¢ æ‡‰ä»˜å¸³æ¬¾ï¼ˆä¸Šæ¸¸ä¾›æ‡‰å•†ï¼‰</h2>
    <div class="hint">
      æœ€ä¸Šæ¸¸å¤šç‚ºã€Œæ¯é€±çµç®—ã€ã€‚æ­¤è¡¨ç¨ç«‹æ–¼å‡ºè²¨ï¼ˆé€šå¸¸æ˜¯é€²è²¨æˆæœ¬ï¼‰ï¼Œä½ å¯è¨˜éŒ„æ¯æ¬¡é€²è²¨ã€ä»˜æ¬¾é€²åº¦èˆ‡é€±æœŸã€‚
    </div>

    <div class="row grid-4" style="margin-top:12px">
      <div><label>æ—¥æœŸ</label><input type="date" id="ap-date"></div>
      <div><label>ä¾›æ‡‰å•†</label><input id="ap-vendor" placeholder="ä¾‹ï¼šé…è²¨å•†X"></div>
      <div><label>å“é …/å‚™è¨»</label><input id="ap-item" placeholder="ä¾‹ï¼šå…¨é› 100 éš»"></div>
      <div><label>é‡‘é¡</label><input type="number" step="0.01" id="ap-amount" placeholder="é€²è²¨ç¸½é¡"></div>
      <div><label>çµç®—é€±æœŸ</label>
        <select id="ap-cycle">
          <option value="æ¯é€±äº”çµç®—">æ¯é€±äº”çµç®—</option>
          <option value="æ¯é€±çµç®—">æ¯é€±çµç®—</option>
          <option value="æœˆçµ">æœˆçµ</option>
          <option value="å…¶ä»–">å…¶ä»–</option>
        </select>
      </div>
      <div><label>ä»˜æ¬¾ç‹€æ…‹</label>
        <select id="ap-status">
          <option value="æœªä»˜æ¬¾">æœªä»˜æ¬¾</option>
          <option value="éƒ¨åˆ†ä»˜æ¬¾">éƒ¨åˆ†ä»˜æ¬¾</option>
          <option value="å·²çµæ¸…">å·²çµæ¸…</option>
        </select>
      </div>
      <div><label>å·²ä»˜é‡‘é¡</label><input type="number" step="0.01" id="ap-paid"></div>
      <div><label>ä»˜æ¬¾æ—¥æœŸ</label><input type="date" id="ap-paid-date"></div>
    </div>
    <div class="right" style="margin-top:10px">
      <button class="btn" id="btn-ap-clear">æ¸…ç©º</button>
      <button class="btn primary" id="btn-ap-add">æ–°å¢æ‡‰ä»˜</button>
    </div>

    <div class="totals" style="margin-top:16px">
      <div class="kpi">æœ¬æœˆæ‡‰ä»˜ï¼š<b class="mono" id="ap-month-sum">0</b></div>
      <div class="kpi">æœ¬æœˆæœªä»˜ï¼š<b class="mono" id="ap-month-unpaid">0</b></div>
    </div>

    <div class="card" style="margin-top:12px;padding:0;overflow:auto;max-height:60vh">
      <table id="tbl-ap">
        <thead>
          <tr>
            <th>æ—¥æœŸ</th><th>ä¾›æ‡‰å•†</th><th>å“é …/å‚™è¨»</th><th>çµç®—é€±æœŸ</th>
            <th>é‡‘é¡</th><th>å·²ä»˜</th><th>æœªä»˜</th><th>ä»˜æ¬¾æ—¥æœŸ</th><th>ç‹€æ…‹</th><th>åˆªé™¤</th>
          </tr>
        </thead>
        <tbody></tbody>
        <tfoot>
          <tr>
            <th colspan="4" style="text-align:right">å°è¨ˆ</th>
            <th class="mono" id="ap-sub-sum">0</th>
            <th class="mono" id="ap-sub-paid">0</th>
            <th class="mono" id="ap-sub-unpaid">0</th>
            <th colspan="3"></th>
          </tr>
        </tfoot>
      </table>
    </div>
  </section>

  <!-- çµ±è¨ˆåˆ†æ -->
  <section class="card" id="tab-analytics" style="display:none">
    <h2 style="margin:0 0 10px">â‘£ ç¶“ç‡Ÿçµ±è¨ˆèˆ‡è¶¨å‹¢</h2>
    <div class="toolbar">
      <div class="flex"><label>å¹´åº¦</label><input class="input-sm" type="number" id="ana-year" min="2000" max="2100"></div>
      <button class="btn" id="btn-ana-refresh">æ›´æ–°åˆ†æ</button>
    </div>

    <div class="totals" style="margin-top:12px">
      <div class="kpi">ä»Šå¹´ç´¯è¨ˆç‡Ÿæ”¶ï¼š<b class="mono" id="ana-ytd">0</b></div>
      <div class="kpi">æœ¬å¹´ç­†æ•¸ï¼š<b class="mono" id="ana-count">0</b></div>
      <div class="kpi">Top å®¢æˆ¶ï¼š<b id="ana-top-client">â€”</b></div>
    </div>

    <div class="card" style="margin-top:12px">
      <div class="flex" style="justify-content:space-between;align-items:center">
        <h3 style="margin:0">æ¯æœˆç‡Ÿæ”¶è¶¨å‹¢</h3>
        <span class="hint">ç”¨å–®æª” SVG ç•«åœ–ï¼ˆç„¡å¤–æ›ï¼‰ï¼Œæ»‘é¼ ç§»åˆ°æŸ±ç‹€å¯çœ‹é‡‘é¡ã€‚</span>
      </div>
      <div class="chart" id="bar-chart" aria-label="æœˆç‡Ÿæ”¶æŸ±ç‹€åœ–"></div>
    </div>

    <div class="card" style="margin-top:12px;padding:0;overflow:auto">
      <table id="tbl-top-client">
        <thead><tr><th>å®¢æˆ¶</th><th>æœˆå¹³å‡</th><th>å¹´ç´¯è¨ˆ</th><th>ç©©å®šåº¦ï¼ˆæœˆä»½æœ‰ä¸‹å–®æ•¸/12ï¼‰</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <!-- è¨­å®šï¼åŒ¯å…¥åŒ¯å‡º -->
  <section class="card" id="tab-settings" style="display:none">
    <h2 style="margin:0 0 10px">è¨­å®š / åŒ¯å…¥åŒ¯å‡º</h2>
    <div class="row grid-3">
      <div class="card">
        <h3 style="margin-top:0">çµç®—è¦å‰‡ï¼ˆé è¨­ï¼‰</h3>
        <div class="row">
          <div>
            <label>ä¸‹æ¸¸å®¢æˆ¶ï¼šå›ºå®šæœˆçµè¦å‰‡</label>
            <input id="cfg-ar-rule" value="1 è™Ÿçµç®—ï¼Œ15 è™Ÿä»˜">
          </div>
          <div>
            <label>ä¸Šæ¸¸ä¾›æ‡‰ï¼šå¸¸è¦‹é€±çµè¦å‰‡</label>
            <input id="cfg-ap-rule" value="æ¯é€±äº”çµç®—ï¼Œéš”é€±äºŒä»˜æ¬¾">
          </div>
          <button class="btn" id="btn-save-cfg">å„²å­˜è¦å‰‡</button>
          <div class="hint">è¦å‰‡åƒ…ä½œç‚ºæ¬„ä½é å¡«èˆ‡æé†’ï¼Œä¸å½±éŸ¿è¨ˆç®—ã€‚</div>
        </div>
      </div>

      <div class="card">
        <h3 style="margin-top:0">è³‡æ–™åŒ¯å‡º</h3>
        <div class="row">
          <button class="btn" id="btn-export-csv">åŒ¯å‡ºå‡ºè²¨ CSV</button>
          <button class="btn" id="btn-export-json">åŒ¯å‡ºå…¨éƒ¨ JSONï¼ˆå‡ºè²¨/AR/AP/è¨­å®šï¼‰</button>
        </div>
      </div>

      <div class="card">
        <h3 style="margin-top:0">è³‡æ–™åŒ¯å…¥ï¼ˆJSONï¼‰</h3>
        <div class="row">
          <input type="file" id="file-import" accept="application/json">
          <button class="btn warn" id="btn-import">é–‹å§‹åŒ¯å…¥</button>
          <div class="hint danger-text">åŒ¯å…¥æœƒè¦†è“‹æœ¬æ©Ÿè³‡æ–™ï¼Œè«‹å…ˆåŒ¯å‡ºå‚™ä»½ã€‚</div>
        </div>
      </div>
    </div>
  </section>
</main>

<div class="footer">â“˜ è³‡æ–™åƒ…å­˜æ–¼ä½ çš„ç€è¦½å™¨ï¼ˆLocalStorageï¼‰ã€‚æ›é›»è…¦æˆ–æ¸…é™¤ç€è¦½è³‡æ–™æœƒæ¶ˆå¤±ï¼Œè«‹å®šæœŸåŒ¯å‡ºå‚™ä»½ã€‚</div>

<script>
/* ========= å·¥å…· ========= */
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
const fmtMoney = n => (isNaN(n)||n===null)?'0':Number(n).toLocaleString('zh-Hant-TW',{minimumFractionDigits:0,maximumFractionDigits:2});
const todayStr = ()=> new Date().toISOString().slice(0,10);
const ym = d => (d||'').slice(0,7);
const clamp0 = n => Math.max(0, Number(n)||0);

/* ========= LocalStorage ========= */
const KEY = 'poultryBook.v1';
const store = {
  data: { shipments:[], ar: {}, ap:[], cfg:{arRule:'1 è™Ÿçµç®—ï¼Œ15 è™Ÿä»˜', apRule:'æ¯é€±äº”çµç®—ï¼Œéš”é€±äºŒä»˜æ¬¾'} },
  load(){
    try{
      const raw = localStorage.getItem(KEY);
      if(raw){ this.data = JSON.parse(raw); }
    }catch(e){ console.warn(e); }
  },
  save(){ localStorage.setItem(KEY, JSON.stringify(this.data)); }
};
store.load();

/* ========= Tabs ========= */
$$('.tab-btn').forEach(b=>{
  b.addEventListener('click', ()=>{
    $$('.tab-btn').forEach(x=>x.classList.remove('active'));
    b.classList.add('active');
    const tab = b.dataset.tab;
    ['ship','ar','ap','analytics','settings'].forEach(id=>{
      $('#tab-'+id).style.display = (id===tab)?'block':'none';
    });
    if(tab==='ar'){ renderAR(); }
    if(tab==='ap'){ renderAP(); }
    if(tab==='analytics'){ renderAnalytics(); }
  });
});

/* ========= å‡ºè²¨è¡¨å–® ========= */
const sDate = $('#s-date'), sClient=$('#s-client'), sType=$('#s-type'), sPart=$('#s-part'),
      sSpec=$('#s-spec'), sUnit=$('#s-unit'), sWeight=$('#s-weight'), sPrice=$('#s-price'),
      sBirds=$('#s-birds'), sPacks=$('#s-packs'), sAmount=$('#s-amount'), sNote=$('#s-note');

function calcAmount(){
  const weight = Number(sWeight.value)||0;
  const birds = Number(sBirds.value)||0;
  const packs = Number(sPacks.value)||0;
  const price = Number(sPrice.value)||0;
  const qty = weight>0 ? weight : (birds>0? birds : packs);
  const amt = qty * price;
  sAmount.value = fmtMoney(amt);
}
[sWeight,sBirds,sPacks,sPrice].forEach(el=>el.addEventListener('input', calcAmount));

$('#btn-clear-form').addEventListener('click', ()=>{
  [sClient,sPart,sSpec,sWeight,sPrice,sBirds,sPacks,sAmount,sNote].forEach(el=>el.value='');
  sType.value='å…¨é›'; sUnit.value='å…¬æ–¤'; sDate.value = todayStr();
});

$('#btn-add').addEventListener('click', ()=>{
  const rec = {
    id: crypto.randomUUID(),
    date: sDate.value || todayStr(),
    client: (sClient.value||'').trim(),
    type: sType.value,
    part: (sPart.value||'').trim(),
    spec: (sSpec.value||'').trim(),
    unit: sUnit.value,
    weight: Number(sWeight.value)||0,
    birds: Number(sBirds.value)||0,
    packs: Number(sPacks.value)||0,
    price: Number(sPrice.value)||0,
    note: (sNote.value||'').trim()
  };
  if(!rec.client){ alert('è«‹å¡«ã€Œå®¢æˆ¶åç¨±ã€'); return; }
  if(!rec.date){ alert('è«‹é¸æ“‡æ—¥æœŸ'); return; }
  // è¨ˆç®—é‡‘é¡ï¼šé‡é‡å„ªå…ˆï¼Œå…¶æ¬¡éš»æ•¸ï¼Œå†ä¾†ä»¶æ•¸
  const qty = rec.weight>0?rec.weight:(rec.birds>0?rec.birds:rec.packs);
  rec.amount = +(qty * rec.price).toFixed(2);
  store.data.shipments.push(rec);
  store.save();
  renderShipments();
  // ä¿ç•™è¡¨å–®ï¼Œä½†æ¸…é™¤é‡é‡/éš»ä»¶/é‡‘é¡ï¼Œæ–¹ä¾¿é€£çºŒè¼¸å…¥
  [sWeight,sBirds,sPacks,sAmount].forEach(el=>el.value='');
  sPrice.value='';
  sPart.value=''; sSpec.value=''; sNote.value='';
  sClient.focus();
});

/* é è¨­æ—¥æœŸä»Šå¤© */
if(!sDate.value) sDate.value = todayStr();

/* ========= å‡ºè²¨è¡¨æ ¼ & ç¯©é¸ ========= */
const filter = $('#filter'), fMonth = $('#filter-month'), fClient=$('#filter-client');
$('#btn-reset-filter').addEventListener('click', ()=>{ filter.value=''; fMonth.value=''; fClient.value=''; renderShipments(); });

function renderShipments(){
  const tbody = $('#tbl-ship tbody');
  tbody.innerHTML = '';
  const q = (filter.value||'').toLowerCase();
  const ymVal = fMonth.value;
  const clientQ = (fClient.value||'').trim();
  const list = store.data.shipments.filter(r=>{
    if(ymVal && ym(r.date)!==ymVal) return false;
    if(clientQ && r.client!==clientQ) return false;
    const hay = [r.client,r.type,r.part,r.note].join(' ').toLowerCase();
    return !q || hay.includes(q);
  }).sort((a,b)=> a.date.localeCompare(b.date));
  let subtotal = 0;
  list.forEach(r=>{
    subtotal += r.amount||0;
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${r.date}</td>
      <td>${esc(r.client)}</td>
      <td><span class="pill">${esc(r.type)}</span></td>
      <td>${esc(r.part)}</td>
      <td>${esc(r.spec)}</td>
      <td class="mono">${r.weight||''}</td>
      <td>${esc(r.unit||'')}</td>
      <td class="mono">${r.birds||''}</td>
      <td class="mono">${r.packs||''}</td>
      <td class="mono">${fmtMoney(r.price||0)}</td>
      <td class="mono">${fmtMoney(r.amount||0)}</td>
      <td>${esc(r.note||'')}</td>
      <td><button class="btn danger btn-del" data-id="${r.id}">åˆª</button></td>
    `;
    tbody.appendChild(tr);
  });
  $('#ship-subtotal').textContent = fmtMoney(subtotal);
  // KPI
  const today = todayStr();
  const month = new Date().toISOString().slice(0,7);
  const todaySum = store.data.shipments.filter(r=>r.date===today).reduce((s,r)=>s+(r.amount||0),0);
  const monthSum = store.data.shipments.filter(r=>ym(r.date)===month).reduce((s,r)=>s+(r.amount||0),0);
  $('#kpi-today').textContent = fmtMoney(todaySum);
  $('#kpi-month').textContent = fmtMoney(monthSum);
  $('#kpi-count').textContent = list.length.toString();

  // ç¶å®šåˆªé™¤
  $$('#tbl-ship .btn-del').forEach(b=>{
    b.addEventListener('click', ()=>{
      const id = b.dataset.id;
      if(confirm('ç¢ºå®šåˆªé™¤æ­¤ç­†å‡ºè²¨æ˜ç´°ï¼Ÿ')){
        store.data.shipments = store.data.shipments.filter(x=>x.id!==id);
        store.save();
        renderShipments();
      }
    });
  });

  // å®¢æˆ¶æ¸…å–®è‡ªå‹•æç¤ºï¼ˆç°¡æ˜“ï¼‰
  const uniqClients = [...new Set(store.data.shipments.map(r=>r.client))].filter(Boolean).sort();
  fClient.setAttribute('list','datalist-clients');
  if(!$('#datalist-clients')){
    const dl = document.createElement('datalist');
    dl.id = 'datalist-clients';
    document.body.appendChild(dl);
  }
  $('#datalist-clients').innerHTML = uniqClients.map(c=>`<option value="${esc(c)}">`).join('');
}
function esc(s){ return (s||'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }
renderShipments();

/* ========= æ‡‰æ”¶å¸³æ¬¾ï¼ˆå½™ç¸½ï¼‰ ========= */
const arMonth = $('#ar-month');
if(!arMonth.value){ arMonth.value = new Date().toISOString().slice(0,7); }
function renderAR(){
  const tbody = $('#tbl-ar tbody'); tbody.innerHTML='';
  const month = arMonth.value || new Date().toISOString().slice(0,7);
  const cfgRule = store.data.cfg.arRule || '1 è™Ÿçµç®—ï¼Œ15 è™Ÿä»˜';

  // ç•¶æœˆå„å®¢æˆ¶é‡‘é¡
  const map = new Map();
  store.data.shipments.filter(r=>ym(r.date)===month).forEach(r=>{
    const k = r.client||'(æœªå¡«å®¢æˆ¶)';
    map.set(k, (map.get(k)||0) + (r.amount||0));
  });

  // å·²æ”¶é‡‘é¡è³‡æ–™å®¹å™¨ï¼ˆæ¯æœˆ-å®¢æˆ¶ä¸€ç­†ï¼‰
  if(!store.data.ar[month]) store.data.ar[month] = {};
  const arMonthObj = store.data.ar[month];

  [...map.entries()].sort((a,b)=> b[1]-a[1]).forEach(([client,total])=>{
    const row = arMonthObj[client] || { received:0, recvDate:'', bank:'', settle:'1 è™Ÿ', due:'15 è™Ÿ' };
    if(!row.settle && !row.due){ row.settle='1 è™Ÿ'; row.due='15 è™Ÿ'; }
    const tr = document.createElement('tr');
    const unpaid = Math.max(0, +(total - (Number(row.received)||0)).toFixed(2));
    const status = unpaid<=0? `<span class="pill green">å·²çµæ¸…</span>` :
                   `<span class="pill red">æœªçµæ¸…</span>`;
    tr.innerHTML = `
      <td>${esc(client)}</td>
      <td class="mono">${fmtMoney(total)}</td>
      <td contenteditable class="nowrap td-settle">${esc(row.settle||'1 è™Ÿ')}</td>
      <td contenteditable class="nowrap td-due">${esc(row.due||'15 è™Ÿ')}</td>
      <td contenteditable class="mono td-received">${row.received||0}</td>
      <td class="mono td-unpaid">${fmtMoney(unpaid)}</td>
      <td contenteditable class="td-recvDate">${esc(row.recvDate||'')}</td>
      <td contenteditable class="td-bank">${esc(row.bank||'')}</td>
      <td>${status}</td>
    `;
    tbody.appendChild(tr);

    // ç·¨è¼¯å„²å­˜
    tr.querySelector('.td-received').addEventListener('input', ()=> saveAR(client, month, tr, total));
    tr.querySelector('.td-recvDate').addEventListener('input', ()=> saveAR(client, month, tr, total));
    tr.querySelector('.td-bank').addEventListener('input', ()=> saveAR(client, month, tr, total));
    tr.querySelector('.td-settle').addEventListener('input', ()=> saveAR(client, month, tr, total));
    tr.querySelector('.td-due').addEventListener('input', ()=> saveAR(client, month, tr, total));
  });

  function saveAR(client, month, tr, total){
    const received = clamp0(tr.querySelector('.td-received').textContent);
    const recvDate = tr.querySelector('.td-recvDate').textContent.trim();
    const bank = tr.querySelector('.td-bank').textContent.trim();
    const settle = tr.querySelector('.td-settle').textContent.trim() || '1 è™Ÿ';
    const due = tr.querySelector('.td-due').textContent.trim() || '15 è™Ÿ';
    if(!store.data.ar[month]) store.data.ar[month] = {};
    store.data.ar[month][client] = { received, recvDate, bank, settle, due };
    tr.querySelector('.td-unpaid').textContent = fmtMoney(Math.max(0, total - received));
    store.save();
  }
}
$('#btn-ar-refresh').addEventListener('click', renderAR);
arMonth.addEventListener('change', renderAR);

/* ========= æ‡‰ä»˜ï¼ˆä¸Šæ¸¸ï¼‰ ========= */
const apDate=$('#ap-date'), apVendor=$('#ap-vendor'), apItem=$('#ap-item'),
      apAmount=$('#ap-amount'), apCycle=$('#ap-cycle'), apStatus=$('#ap-status'),
      apPaid=$('#ap-paid'), apPaidDate=$('#ap-paid-date');

if(!apDate.value) apDate.value = todayStr();

$('#btn-ap-clear').addEventListener('click', ()=>{
  [apVendor,apItem,apAmount,apPaid,apPaidDate].forEach(x=>x.value='');
  apCycle.value='æ¯é€±äº”çµç®—'; apStatus.value='æœªä»˜æ¬¾'; apDate.value = todayStr();
});

$('#btn-ap-add').addEventListener('click', ()=>{
  const rec = {
    id: crypto.randomUUID(),
    date: apDate.value || todayStr(),
    vendor: (apVendor.value||'').trim(),
    item: (apItem.value||'').trim(),
    cycle: apCycle.value,
    amount: clamp0(apAmount.value),
    paid: clamp0(apPaid.value),
    paidDate: apPaidDate.value || '',
    status: apStatus.value
  };
  if(!rec.vendor){ alert('è«‹å¡«ã€Œä¾›æ‡‰å•†ã€'); return; }
  store.data.ap.push(rec);
  store.save();
  renderAP();
});

function renderAP(){
  const tbody = $('#tbl-ap tbody'); tbody.innerHTML='';
  let sum=0, paid=0, unpaid=0;
  store.data.ap.sort((a,b)=> a.date.localeCompare(b.date)).forEach(r=>{
    const u = Math.max(0, (r.amount||0)-(r.paid||0));
    sum += r.amount||0; paid += r.paid||0; unpaid += u;
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${r.date}</td>
      <td>${esc(r.vendor)}</td>
      <td>${esc(r.item)}</td>
      <td>${esc(r.cycle)}</td>
      <td class="mono">${fmtMoney(r.amount||0)}</td>
      <td class="mono">${fmtMoney(r.paid||0)}</td>
      <td class="mono">${fmtMoney(u)}</td>
      <td>${esc(r.paidDate||'')}</td>
      <td>${r.status==='å·²çµæ¸…'?'<span class="pill green">å·²çµæ¸…</span>':(r.status==='éƒ¨åˆ†ä»˜æ¬¾'?'<span class="pill">éƒ¨åˆ†</span>':'<span class="pill red">æœªä»˜</span>')}</td>
      <td><button class="btn danger btn-ap-del" data-id="${r.id}">åˆª</button></td>
    `;
    tbody.appendChild(tr);
  });
  $('#ap-sub-sum').textContent = fmtMoney(sum);
  $('#ap-sub-paid').textContent = fmtMoney(paid);
  $('#ap-sub-unpaid').textContent = fmtMoney(unpaid);

  // ç•¶æœˆ KPI
  const m = new Date().toISOString().slice(0,7);
  const monthRows = store.data.ap.filter(r=>ym(r.date)===m);
  const mSum = monthRows.reduce((s,r)=>s+(r.amount||0),0);
  const mUnpaid = monthRows.reduce((s,r)=>s+Math.max(0,(r.amount||0)-(r.paid||0)),0);
  $('#ap-month-sum').textContent = fmtMoney(mSum);
  $('#ap-month-unpaid').textContent = fmtMoney(mUnpaid);

  $$('#tbl-ap .btn-ap-del').forEach(b=>{
    b.addEventListener('click', ()=>{
      const id = b.dataset.id;
      if(confirm('ç¢ºå®šåˆªé™¤æ­¤ç­†æ‡‰ä»˜ï¼Ÿ')){
        store.data.ap = store.data.ap.filter(x=>x.id!==id);
        store.save();
        renderAP();
      }
    });
  });
}
renderAP();

/* ========= çµ±è¨ˆåˆ†æ ========= */
const anaYear = $('#ana-year');
if(!anaYear.value) anaYear.value = new Date().getFullYear();
$('#btn-ana-refresh').addEventListener('click', renderAnalytics);

function renderAnalytics(){
  const Y = Number(anaYear.value)||new Date().getFullYear();
  const list = store.data.shipments.filter(r=> (r.date||'').startsWith(String(Y)));
  const ytd = list.reduce((s,r)=>s+(r.amount||0),0);
  $('#ana-ytd').textContent = fmtMoney(ytd);
  $('#ana-count').textContent = list.length.toString();

  // å®¢æˆ¶çµ±è¨ˆ
  const byClient = new Map();
  const byMonth = new Array(12).fill(0);
  list.forEach(r=>{
    byClient.set(r.client, (byClient.get(r.client)||0)+(r.amount||0));
    const m = new Date(r.date).getMonth(); if(!isNaN(m)) byMonth[m] += r.amount||0;
  });
  const top = [...byClient.entries()].sort((a,b)=>b[1]-a[1])[0];
  $('#ana-top-client').textContent = top? `${top[0]}ï¼ˆ${fmtMoney(top[1])}ï¼‰` : 'â€”';

  // Top å®¢æˆ¶è¡¨ï¼šå¹´ç´¯è¨ˆã€æœˆå¹³å‡ã€ç©©å®šåº¦ï¼ˆæœ‰ä¸‹å–®æœˆä»½/12ï¼‰
  const tbody = $('#tbl-top-client tbody'); tbody.innerHTML='';
  [...byClient.entries()].sort((a,b)=>b[1]-a[1]).slice(0,20).forEach(([client,total])=>{
    const monthsSet = new Set(
      store.data.shipments
        .filter(r=>r.client===client && (r.date||'').startsWith(String(Y)))
        .map(r=> new Date(r.date).getMonth())
    );
    const activeMonths = monthsSet.size;
    const avg = total / 12;
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${esc(client)}</td>
      <td class="mono">${fmtMoney(avg)}</td>
      <td class="mono">${fmtMoney(total)}</td>
      <td>${activeMonths}/12</td>
    `;
    tbody.appendChild(tr);
  });

  // ç¹ªè£½æŸ±ç‹€åœ–ï¼ˆç´” SVGï¼‰
  drawBarChart('#bar-chart', byMonth);
}

function drawBarChart(selector, arr){
  const el = document.querySelector(selector);
  const W = el.clientWidth||600, H = 240, padL=40, padR=10, padT=10, padB=24;
  const max = Math.max(1, ...arr);
  const bw = (W - padL - padR) / arr.length;
  const toY = v => H - padB - (v/max)*(H - padT - padB);
  const months = ['1','2','3','4','5','6','7','8','9','10','11','12'];

  let svg = `<svg width="${W}" height="${H}" xmlns="http://www.w3.org/2000/svg" role="img" aria-label="æ¯æœˆç‡Ÿæ”¶æŸ±ç‹€åœ–">`;
  // yè»¸ç·š
  svg += `<line x1="${padL}" y1="${padT}" x2="${padL}" y2="${H-padB}" stroke="#1f2937"/>`;
  // xè»¸ç·š
  svg += `<line x1="${padL}" y1="${H-padB}" x2="${W-padR}" y2="${H-padB}" stroke="#1f2937"/>`;

  // æŸ±
  arr.forEach((v,i)=>{
    const x = padL + i*bw + 6;
    const y = toY(v);
    const h = (H-padB) - y;
    svg += `<rect x="${x}" y="${y}" width="${Math.max(6,bw-12)}" height="${Math.max(0,h)}" fill="#22c55e">
              <title>${months[i]} æœˆï¼š${fmtMoney(v)}</title>
            </rect>`;
    // x æ¨™ç±¤
    svg += `<text x="${padL + i*bw + bw/2}" y="${H-6}" text-anchor="middle" font-size="11" fill="#94a3b8">${months[i]}</text>`;
  });

  // y æ¨™ç±¤ï¼ˆæœ€å¤§å€¼ï¼‰
  svg += `<text x="8" y="${toY(max)}" font-size="11" fill="#94a3b8">${fmtMoney(max)}</text>`;
  svg += `</svg>`;
  el.innerHTML = svg;
}

/* ========= è¨­å®šï¼åŒ¯å‡ºåŒ¯å…¥ ========= */
$('#cfg-ar-rule').value = store.data.cfg.arRule || '1 è™Ÿçµç®—ï¼Œ15 è™Ÿä»˜';
$('#cfg-ap-rule').value = store.data.cfg.apRule || 'æ¯é€±äº”çµç®—ï¼Œéš”é€±äºŒä»˜æ¬¾';
$('#btn-save-cfg').addEventListener('click', ()=>{
  store.data.cfg.arRule = ($('#cfg-ar-rule').value||'').trim();
  store.data.cfg.apRule = ($('#cfg-ap-rule').value||'').trim();
  store.save();
  alert('å·²å„²å­˜');
});

$('#btn-export-csv').addEventListener('click', ()=>{
  const headers = ['æ—¥æœŸ','å®¢æˆ¶','é¡åˆ¥','éƒ¨ä½','è¦æ ¼','é‡é‡','å–®ä½','éš»æ•¸','ä»¶æ•¸','å–®åƒ¹','é‡‘é¡','å‚™è¨»'];
  const rows = store.data.shipments.map(r=>[
    r.date,r.client,r.type,r.part,r.spec,r.weight,r.unit,r.birds,r.packs,r.price,r.amount,r.note
  ]);
  const csv = [headers.join(','), ...rows.map(r=>r.map(v=> `"${String(v??'').replace(/"/g,'""')}"`).join(','))].join('\n');
  download('shipments.csv', csv, 'text/csv;charset=utf-8;');
});

$('#btn-export-json').addEventListener('click', ()=>{
  download('poultry-data.json', JSON.stringify(store.data,null,2), 'application/json');
});

function download(filename, content, mime){
  const blob = new Blob([content], {type:mime});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = filename;
  a.click();
  URL.revokeObjectURL(a.href);
}

$('#btn-import').addEventListener('click', ()=>{
  const f = $('#file-import').files[0];
  if(!f){ alert('è«‹é¸æ“‡ JSON æª”'); return; }
  const reader = new FileReader();
  reader.onload = e=>{
    try{
      const data = JSON.parse(e.target.result);
      if(!data || !data.shipments){ throw new Error('æ ¼å¼ä¸æ­£ç¢º'); }
      store.data = data; store.save();
      renderShipments(); renderAP(); renderAR(); renderAnalytics();
      alert('åŒ¯å…¥å®Œæˆ');
    }catch(err){
      alert('åŒ¯å…¥å¤±æ•—ï¼š'+err.message);
    }
  };
  reader.readAsText(f, 'utf-8');
});

/* ========= åˆå§‹åŒ– ========= */
function init(){
  renderShipments(); renderAR(); renderAP(); renderAnalytics();
}
init();
</script>
</body>
</html>
