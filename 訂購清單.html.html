<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>生鮮雞 出貨／帳務／經營分析（範本）</title>
<style>
  :root {
    --bg:#0f172a; --card:#111827; --muted:#1f2937; --text:#e5e7eb; --soft:#9ca3af; --accent:#22d3ee; --ok:#22c55e; --warn:#f59e0b; --bad:#ef4444;
    --gap:14px; --radius:16px;
  }
  *{box-sizing:border-box}
  body{margin:0; font-family:system-ui,-apple-system,"Segoe UI",Roboto,Inter,"Noto Sans TC",sans-serif; background:var(--bg); color:var(--text); line-height:1.5}
  header{padding:20px clamp(16px,3vw,32px); border-bottom:1px solid #1f2937; position:sticky; top:0; background:linear-gradient(180deg, rgba(15,23,42,.98), rgba(15,23,42,.84)); backdrop-filter: blur(6px); z-index:9}
  h1{margin:0;font-size:20px; letter-spacing:.5px}
  .wrap{padding:20px clamp(16px,3vw,32px)}
  .grid{display:grid; gap:var(--gap)}
  .cols-2{grid-template-columns: repeat(2,minmax(0,1fr))}
  .cols-3{grid-template-columns: repeat(3,minmax(0,1fr))}
  @media (max-width: 1000px){ .cols-2,.cols-3{grid-template-columns:1fr} }
  .card{background:var(--card); border:1px solid #1f2937; border-radius:var(--radius); padding:16px; box-shadow: 0 8px 24px rgba(0,0,0,.25)}
  .title{display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:10px}
  .title h2{margin:0; font-size:18px}
  .title small{color:var(--soft)}
  label{display:block; font-size:12px; color:var(--soft); margin-bottom:6px}
  input,select,button,textarea{width:100%; padding:10px 12px; border-radius:10px; border:1px solid #334155; background:#0b1220; color:var(--text)}
  input[type="date"]{background:#0b1220}
  .row{display:grid; grid-template-columns: repeat(6, 1fr); gap:var(--gap)}
  .row > div{min-width:0}
  .btn{cursor:pointer; border:1px solid #374151; background:#0b1324; transition:.2s; font-weight:600}
  .btn:hover{transform: translateY(-1px); border-color:#4b5563}
  .btn.primary{background:linear-gradient(180deg,#0ea5e9,#0891b2); border:0}
  .btn.good{background:linear-gradient(180deg,#16a34a,#15803d); border:0}
  .btn.warn{background:linear-gradient(180deg,#f59e0b,#b45309); border:0}
  .btn.ghost{background:transparent; border:1px dashed #334155}
  .tools{display:flex; gap:8px; flex-wrap:wrap}
  table{width:100%; border-collapse:separate; border-spacing:0; background:#0b1220; border:1px solid #1f2937; border-radius:12px; overflow:hidden}
  th,td{padding:10px 12px; border-bottom:1px solid #1f2937; font-size:14px; text-align:left; white-space:nowrap}
  th{position:sticky; top:0; background:#111827; z-index:1}
  tbody tr:hover{background:#0e1729}
  .right{text-align:right}
  .pill{display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; border:1px solid #334155; background:#0b1324}
  .ok{color:#86efac}.bad{color:#fca5a5}.muted{color:var(--soft)}
  .sep{height:1px; background:#1f2937; margin:12px 0}
  canvas{width:100%; height:260px; background: #0b1220; border:1px solid #1f2937; border-radius:12px}
  .note{font-size:12px; color:var(--soft)}
  .print-hide{display:initial}
  @media print{
    header, .print-hide{display:none!important}
    body{background:#fff; color:#000}
    .card{border:1px solid #000}
    table{border-color:#000}
    th,td{border-color:#000}
  }
</style>
</head>
<body>
<header>
  <h1>生鮮雞｜出貨／交易基本紀錄、帳務結算、經營分析</h1>
  <div class="note">流程：新增出貨 ➜ 每日明細 ➜ 應收/收款 ➜ 半月結算 ➜ 趨勢與毛利率</div>
</header>

<div class="wrap grid cols-2">
  <!-- 出貨單輸入 -->
  <section class="card">
    <div class="title">
      <h2>出貨單（新增）</h2><small>每日三千隻：支援「全雞 / 分切 / 冷凍」等類別</small>
    </div>
    <div class="grid cols-3">
      <div>
        <label>日期</label>
        <input type="date" id="ship_date">
      </div>
      <div>
        <label>客戶名稱</label>
        <input type="text" id="ship_customer" placeholder="煮雞廠A / 餐館B / 代工廠C">
      </div>
      <div>
        <label>類別</label>
        <select id="ship_category">
          <option>全雞</option>
          <option>分切</option>
          <option>冷凍</option>
        </select>
      </div>

      <div>
        <label>部位</label>
        <input type="text" id="ship_part" placeholder="去骨腿 / 胸 / 翅中…">
      </div>
      <div>
        <label>規格</label>
        <input type="text" id="ship_spec" placeholder="例：1.8kg/隻、散裝10件/箱…">
      </div>
      <div>
        <label>單位</label>
        <select id="ship_unit">
          <option>公斤</option>
          <option>克</option>
          <option>斤</option>
        </select>
      </div>

      <div>
        <label>重量</label>
        <input type="number" step="0.001" id="ship_weight" placeholder="kg / g / 斤">
      </div>
      <div>
        <label>隻數</label>
        <input type="number" step="1" id="ship_count_birds" placeholder="例如 120">
      </div>
      <div>
        <label>件數</label>
        <input type="number" step="1" id="ship_count_cases" placeholder="例如 20">
      </div>

      <div>
        <label>單價（售價）</label>
        <input type="number" step="0.01" id="ship_price" placeholder="每單位售價">
      </div>
      <div>
        <label>進貨成本單價</label>
        <input type="number" step="0.01" id="ship_cost" placeholder="每單位成本">
      </div>
      <div>
        <label>備註</label>
        <input type="text" id="ship_note" placeholder="客製規格、急件、司機…">
      </div>
    </div>
    <div class="sep"></div>
    <div class="tools">
      <button class="btn primary" onclick="addShipment()">新增出貨</button>
      <button class="btn ghost" onclick="resetShipForm()">清空</button>
      <button class="btn" onclick="window.print()">列印（簽單/留底）</button>
    </div>
  </section>

  <!-- 收款紀錄 -->
  <section class="card">
    <div class="title">
      <h2>收款紀錄（新增）</h2><small>更新「已收 / 未收」與應收帳款</small>
    </div>
    <div class="grid cols-3">
      <div>
        <label>收款日期</label>
        <input type="date" id="pay_date">
      </div>
      <div>
        <label>客戶名稱</label>
        <input type="text" id="pay_customer" placeholder="與出貨客戶一致">
      </div>
      <div>
        <label>收款金額</label>
        <input type="number" step="0.01" id="pay_amount" placeholder="例：50000">
      </div>
      <div>
        <label>匯款帳號</label>
        <input type="text" id="pay_account" placeholder="銀行/帳號末五碼…">
      </div>
      <div>
        <label>備註</label>
        <input type="text" id="pay_note" placeholder="現金/匯款/票據…">
      </div>
    </div>
    <div class="sep"></div>
    <div class="tools">
      <button class="btn good" onclick="addPayment()">記錄收款</button>
      <button class="btn ghost" onclick="resetPayForm()">清空</button>
    </div>
  </section>

  <!-- 每筆單項明細 -->
  <section class="card">
    <div class="title">
      <h2>每日明細</h2>
      <small>日期｜類別｜客戶｜部位｜重量/單位｜隻數｜件數｜單價｜金額｜成本｜毛利</small>
    </div>
    <div class="tools print-hide">
      <input id="filter_date_from" type="date" />
      <input id="filter_date_to" type="date" />
      <input id="filter_customer" type="text" placeholder="篩選客戶">
      <button class="btn" onclick="renderDetail()">套用篩選</button>
      <button class="btn ghost" onclick="clearFilters()">清除篩選</button>
    </div>
    <div style="max-height:420px; overflow:auto; margin-top:10px">
      <table id="detail_table">
        <thead>
          <tr>
            <th>日期</th><th>類別</th><th>客戶</th><th>部位</th>
            <th class="right">重量</th><th>單位</th><th class="right">隻</th><th class="right">件</th>
            <th class="right">單價</th><th class="right">金額</th>
            <th class="right">成本額</th><th class="right">毛利</th><th class="right">毛利率</th>
            <th>備註</th><th>操作</th>
          </tr>
        </thead>
        <tbody></tbody>
        <tfoot>
          <tr>
            <th colspan="9" class="right">合計</th>
            <th class="right" id="detail_sum_amount">0</th>
            <th class="right" id="detail_sum_cost">0</th>
            <th class="right" id="detail_sum_profit">0</th>
            <th class="right" id="detail_avg_margin">0%</th>
            <th></th>
          </tr>
        </tfoot>
      </table>
    </div>
  </section>

  <!-- 應收帳款 / 付款進度 -->
  <section class="card">
    <div class="title">
      <h2>應收帳款 / 付款進度</h2>
      <small>一目了然：已收金額、未收金額、最近收款日、匯款帳號</small>
    </div>
    <div style="max-height:420px; overflow:auto">
      <table id="ar_table">
        <thead>
          <tr>
            <th>客戶</th>
            <th class="right">出貨金額</th>
            <th class="right">已收</th>
            <th class="right">未收</th>
            <th>最近收款日</th>
            <th>匯款帳號</th>
          </tr>
        </thead>
        <tbody></tbody>
        <tfoot>
          <tr>
            <th>總計</th>
            <th class="right" id="ar_total_ship">0</th>
            <th class="right" id="ar_total_paid">0</th>
            <th class="right" id="ar_total_unpaid">0</th>
            <th></th><th></th>
          </tr>
        </tfoot>
      </table>
    </div>
  </section>

  <!-- 半月結算 -->
  <section class="card">
    <div class="title">
      <h2>半月結算（1–15、16–月底）</h2>
      <small>範圍依據「出貨日期」自動統計</small>
    </div>
    <div class="tools print-hide">
      <input type="month" id="settle_month" />
      <button class="btn" onclick="renderSettlement()">結算本月</button>
      <button class="btn warn" onclick="renderSettlement(true)">結算並顯示客戶分組</button>
    </div>
    <div class="grid cols-2">
      <div>
        <h3>上半月（1–15）</h3>
        <table id="set_first">
          <thead><tr><th>項目</th><th class="right">金額</th></tr></thead>
          <tbody></tbody>
          <tfoot><tr><th>合計</th><th class="right" id="set_first_sum">0</th></tr></tfoot>
        </table>
      </div>
      <div>
        <h3>下半月（16–月底）</h3>
        <table id="set_second">
          <thead><tr><th>項目</th><th class="right">金額</th></tr></thead>
          <tbody></tbody>
          <tfoot><tr><th>合計</th><th class="right" id="set_second_sum">0</th></tr></tfoot>
        </table>
      </div>
    </div>
  </section>

  <!-- 經營統計圖 -->
  <section class="card">
    <div class="title">
      <h2>統計分析（營收趨勢／毛利率）</h2>
      <small>每週或每月更新即可，掌握淡旺季與風險</small>
    </div>
    <div class="grid cols-2">
      <div>
        <label>時間粒度</label>
        <select id="agg_gran" onchange="renderCharts()">
          <option value="month">按月</option>
          <option value="week">按週</option>
        </select>
        <canvas id="rev_chart"></canvas>
      </div>
      <div>
        <label>毛利（銷售－成本）與毛利率</label>
        <canvas id="gp_chart"></canvas>
      </div>
    </div>
    <div class="note" style="margin-top:8px">
      註：金額＝「單價 × 重量（若有）」，否則使用「單價 × 件數/隻數（擇一）」。可依實務需要調整。
    </div>
  </section>
</div>

<script>
/** ====== 簡易資料存放（頁面內存） ====== **/
let shipments = []; // 每筆出貨
let payments  = []; // 每筆收款

/** ====== 工具 ====== **/
const $ = (id)=>document.getElementById(id);
const pad2 = (n)=> String(n).padStart(2,'0');
const fmt = (n)=> (isNaN(n)?0:n).toLocaleString(undefined,{minimumFractionDigits:0, maximumFractionDigits:0});
const fmts = (n)=> (isNaN(n)?0:n).toLocaleString(undefined,{minimumFractionDigits:2, maximumFractionDigits:2});
const parseN = (v)=> { const n = parseFloat(v); return isNaN(n)?0:n; };
const within = (d, from, to) => (!from || d>=from) && (!to || d<=to);

/** 單位換算（全部換算到「公斤」作為計價基準，可依需要調整） */
function normalizeWeight(weight, unit){
  const w = parseN(weight);
  if(!w) return 0;
  if(unit === '公斤') return w;
  if(unit === '克')    return w/1000;
  if(unit === '斤')    return w*0.6; // 台斤 600g
  return w;
}

/** 計算金額與成本 */
function calcAmounts(row){
  const wkg = normalizeWeight(row.weight, row.unit);
  const price = parseN(row.price);
  const cost  = parseN(row.cost);
  let amount = 0, costAmount = 0;

  if(wkg>0){
    amount = wkg * price;
    costAmount = wkg * cost;
  }else if(parseN(row.count_cases)>0){
    amount = parseN(row.count_cases) * price;
    costAmount = parseN(row.count_cases) * cost;
  }else if(parseN(row.count_birds)>0){
    amount = parseN(row.count_birds) * price;
    costAmount = parseN(row.count_birds) * cost;
  }
  const profit = amount - costAmount;
  const margin = amount>0 ? (profit/amount)*100 : 0;
  return {amount, costAmount, profit, margin};
}

/** ====== 表單處理 ====== **/
function resetShipForm(){
  ['ship_date','ship_customer','ship_part','ship_spec','ship_weight','ship_count_birds','ship_count_cases','ship_price','ship_cost','ship_note'].forEach(id=>$(id).value='');
  $('ship_category').selectedIndex = 0;
  $('ship_unit').selectedIndex = 0;
}
function resetPayForm(){
  ['pay_date','pay_customer','pay_amount','pay_account','pay_note'].forEach(id=>$(id).value='');
}

function addShipment(){
  const row = {
    id: crypto.randomUUID(),
    date: $('ship_date').value,
    customer: $('ship_customer').value.trim(),
    category: $('ship_category').value,
    part: $('ship_part').value.trim(),
    spec: $('ship_spec').value.trim(),
    unit: $('ship_unit').value,
    weight: $('ship_weight').value,
    count_birds: $('ship_count_birds').value,
    count_cases: $('ship_count_cases').value,
    price: $('ship_price').value,
    cost: $('ship_cost').value,
    note: $('ship_note').value.trim()
  };
  if(!row.date || !row.customer){ alert('請填「日期」與「客戶名稱」'); return; }
  shipments.push(row);
  resetShipForm();
  renderAll();
}

function addPayment(){
  const row = {
    id: crypto.randomUUID(),
    date: $('pay_date').value,
    customer: $('pay_customer').value.trim(),
    amount: parseN($('pay_amount').value),
    account: $('pay_account').value.trim(),
    note: $('pay_note').value.trim()
  };
  if(!row.date || !row.customer || row.amount<=0){ alert('請填「收款日期 / 客戶 / 金額」'); return; }
  payments.push(row);
  resetPayForm();
  renderAll();
}

/** ====== 明細表格 ====== **/
function clearFilters(){
  ['filter_date_from','filter_date_to','filter_customer'].forEach(id=>$(id).value='');
  renderDetail();
}

function renderDetail(){
  const tb = $('detail_table').querySelector('tbody');
  tb.innerHTML = '';
  const from = $('filter_date_from').value;
  const to   = $('filter_date_to').value;
  const kw   = $('filter_customer').value.trim();

  let sumA=0, sumC=0, sumP=0, margins=[];
  shipments
    .filter(r => within(r.date, from, to) && (!kw || r.customer.includes(kw)))
    .sort((a,b)=> (a.date>b.date?1:a.date<b.date?-1:0))
    .forEach(r=>{
      const {amount, costAmount, profit, margin} = calcAmounts(r);
      sumA+=amount; sumC+=costAmount; sumP+=profit; margins.push({amount, margin});
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${r.date}</td>
        <td>${r.category}</td>
        <td>${r.customer}</td>
        <td>${r.part||''}</td>
        <td class="right">${fmts(normalizeWeight(r.weight, r.unit))}</td>
        <td>${r.unit}</td>
        <td class="right">${parseN(r.count_birds)||''}</td>
        <td class="right">${parseN(r.count_cases)||''}</td>
        <td class="right">${fmts(parseN(r.price))}</td>
        <td class="right">${fmt(amount)}</td>
        <td class="right">${fmt(costAmount)}</td>
        <td class="right ${profit>=0?'ok':'bad'}">${fmt(profit)}</td>
        <td class="right">${margin?margin.toFixed(1):'0.0'}%</td>
        <td>${r.note||''}</td>
        <td><button class="btn warn" onclick="delShipment('${r.id}')">刪除</button></td>
      `;
      tb.appendChild(tr);
    });

  $('detail_sum_amount').textContent = fmt(sumA);
  $('detail_sum_cost').textContent   = fmt(sumC);
  $('detail_sum_profit').textContent = fmt(sumP);
  const avgMargin = (()=> {
    let w=0, acc=0;
    margins.forEach(m=>{ w+=m.amount; acc+=m.amount*(isNaN(m.margin)?0:m.margin); });
    return w>0 ? (acc/w) : 0;
  })();
  $('detail_avg_margin').textContent = `${avgMargin.toFixed(1)}%`;
}

function delShipment(id){
  shipments = shipments.filter(r=>r.id!==id);
  renderAll();
}

/** ====== 應收帳款 ====== **/
function sumBy(arr, key){
  return arr.reduce((a,b)=> (a+(+b[key]||0)), 0);
}

function renderAR(){
  const tb = $('ar_table').querySelector('tbody');
  tb.innerHTML = '';

  // 銷售額 by 客戶
  const salesByCust = {};
  shipments.forEach(r=>{
    const {amount} = calcAmounts(r);
    salesByCust[r.customer] = (salesByCust[r.customer]||0) + amount;
  });

  // 已收款 by 客戶
  const paidByCust = {};
  const lastPayDate = {};
  const lastAccount = {};
  payments.forEach(p=>{
    paidByCust[p.customer] = (paidByCust[p.customer]||0) + (p.amount||0);
    if(!lastPayDate[p.customer] || p.date > lastPayDate[p.customer]) lastPayDate[p.customer] = p.date;
    if(p.account) lastAccount[p.customer] = p.account;
  });

  let totalShip=0,totalPaid=0,totalUnpaid=0;
  Object.keys(salesByCust).sort().forEach(c=>{
    const ship = salesByCust[c]||0;
    const paid = paidByCust[c]||0;
    const unpd = ship - paid;
    totalShip += ship; totalPaid += paid; totalUnpaid += unpd;

    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${c}</td>
      <td class="right">${fmt(ship)}</td>
      <td class="right">${fmt(paid)}</td>
      <td class="right ${unpd>0?'bad':''}">${fmt(unpd)}</td>
      <td>${lastPayDate[c]||'-'}</td>
      <td>${lastAccount[c]||'-'}</td>
    `;
    tb.appendChild(tr);
  });

  $('ar_total_ship').textContent = fmt(totalShip);
  $('ar_total_paid').textContent = fmt(totalPaid);
  $('ar_total_unpaid').textContent = fmt(totalUnpaid);
}

/** ====== 半月結算 ====== **/
function renderSettlement(showByCustomer=false){
  const ym = $('settle_month').value;
  if(!ym){ alert('請先選擇結算月份'); return; }
  const [y,m] = ym.split('-').map(Number);
  const lastDay = new Date(y, m, 0).getDate();

  const first = {label:'1–15', sum:0, by:{}};
  const second= {label:`16–${lastDay}`, sum:0, by:{}};

  shipments.forEach(r=>{
    if(!r.date.startsWith(ym)) return;
    const {amount} = calcAmounts(r);
    const d = Number(r.date.split('-')[2]);
    const bucket = d<=15 ? first : second;
    bucket.sum += amount;
    bucket.by[r.customer] = (bucket.by[r.customer]||0)+amount;
  });

  const renderBucket = (elId, bucket)=>{
    const tb = $(elId).querySelector('tbody'); tb.innerHTML='';
    if(showByCustomer){
      Object.entries(bucket.by).sort((a,b)=>b[1]-a[1]).forEach(([c,amt])=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${c}</td><td class="right">${fmt(amt)}</td>`;
        tb.appendChild(tr);
      });
    }else{
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>出貨金額（${bucket.label}）</td><td class="right">${fmt(bucket.sum)}</td>`;
      tb.appendChild(tr);
    }
  };

  renderBucket('set_first', first);
  renderBucket('set_second', second);
  $('set_first_sum').textContent  = fmt(first.sum);
  $('set_second_sum').textContent = fmt(second.sum);
}

/** ====== 統計圖（原生 Canvas） ====== **/
function groupByPeriod(gran){
  const map = {}; // key -> {rev, cost, profit}
  shipments.forEach(r=>{
    const {amount, costAmount, profit} = calcAmounts(r);
    const d = new Date(r.date);
    if(isNaN(d)) return;
    let key;
    if(gran==='week'){
      // ISO week key: YYYY-Www
      const temp = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
      const dayNum = (temp.getUTCDay() || 7);
      temp.setUTCDate(temp.getUTCDate() + 4 - dayNum);
      const yearStart = new Date(Date.UTC(temp.getUTCFullYear(),0,1));
      const weekNo = Math.ceil((((temp - yearStart)/86400000)+1)/7);
      key = `${temp.getUTCFullYear()}-W${pad2(weekNo)}`;
    }else{
      key = `${d.getFullYear()}-${pad2(d.getMonth()+1)}`;
    }
    if(!map[key]) map[key] = {rev:0,cost:0,profit:0};
    map[key].rev += amount;
    map[key].cost += costAmount;
    map[key].profit += profit;
  });
  const keys = Object.keys(map).sort();
  return {
    labels: keys,
    rev: keys.map(k=>map[k].rev),
    profit: keys.map(k=>map[k].profit),
    marginPct: keys.map(k=> map[k].rev>0 ? (map[k].profit/map[k].rev*100) : 0 )
  };
}

function drawLineChart(canvasId, labels, series, opts={}){
  const c = $(canvasId);
  const ctx = c.getContext('2d');
  const W = c.width = c.clientWidth * (window.devicePixelRatio||1);
  const H = c.height= c.clientHeight* (window.devicePixelRatio||1);
  ctx.clearRect(0,0,W,H);

  // margins
  const ml=70, mr=20, mt=20, mb=40;
  const plotW = W-ml-mr, plotH = H-mt-mb;

  // scales
  const maxY = Math.max(1, ...series.flat());
  const minY = Math.min(0, ...series.flat());
  const toX = (i, n)=> ml + (plotW) * (n<=1?0:(i/(n-1)));
  const toY = (v)=> mt + (plotH) * (1 - (v - minY)/(maxY - minY));

  // grid + axes
  ctx.strokeStyle = 'rgba(255,255,255,0.15)';
  ctx.lineWidth = 1;
  ctx.beginPath();
  for(let g=0; g<=5; g++){
    const y = mt + plotH * (g/5);
    ctx.moveTo(ml,y); ctx.lineTo(W-mr,y);
  }
  ctx.stroke();

  // labels Y
  ctx.fillStyle = '#9ca3af'; ctx.font = `${12*(window.devicePixelRatio||1)}px system-ui`;
  for(let g=0; g<=5; g++){
    const yVal = minY + (maxY-minY)*((5-g)/5);
    const y = mt + plotH * (g/5);
    ctx.fillText(yVal.toFixed(0), 8, y+4);
  }

  // X labels
  labels.forEach((lab,i)=>{
    const x = toX(i, labels.length);
    ctx.fillText(lab, x-20, H-8);
  });

  // lines
  const colors = opts.colors || ['#22d3ee','#22c55e','#f59e0b','#ef4444'];
  series.forEach((arr, si)=>{
    ctx.strokeStyle = colors[si%colors.length];
    ctx.lineWidth = 2*(window.devicePixelRatio||1);
    ctx.beginPath();
    arr.forEach((v,i)=>{
      const x=toX(i, arr.length), y=toY(v);
      if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
    });
    ctx.stroke();
  });
}

function renderCharts(){
  const gran = $('agg_gran').value;
  const g = groupByPeriod(gran);
  drawLineChart('rev_chart', g.labels, [g.rev], {colors:['#22d3ee']});
  drawLineChart('gp_chart',  g.labels, [g.marginPct], {colors:['#22c55e']});
}

/** ====== 一鍵重繪 ====== **/
function renderAll(){
  renderDetail();https://github.com/shuaimooo/index/blob/main/%E8%A8%82%E8%B3%BC%E6%B8%85%E5%96%AE.html.html
  renderAR();
  renderSettlement(); // 若未選月份會報警示，不阻斷其它渲染
  renderCharts();
}

/** 初始：帶入今天日期方便輸入 */
(function init(){
  const today = new Date();
  const iso = `${today.getFullYear()}-${pad2(today.getMonth()+1)}-${pad2(today.getDate())}`;
  $('ship_date').value = iso;
  $('pay_date').value  = iso;
  $('settle_month').value = `${today.getFullYear()}-${pad2(today.getMonth()+1)}`;
  renderAll();
})();
</script>
</body>
</html>
